name: Build EXE

on:
  push:
    branches: [ main, master ]
  pull_request:
    branches: [ main, master ]
  workflow_dispatch:

jobs:
  test:
    runs-on: ubuntu-latest
    steps:
    - uses: actions/checkout@v4
    - uses: actions/setup-python@v4
      with:
        python-version: '3.10'
    - name: Test Python script
      run: |
        pip install xlrd openpyxl
        python main.py --help || echo "测试完成"

  build:
    runs-on: windows-latest
    needs: test  # 先运行测试

    steps:
    - uses: actions/checkout@v4

    - uses: actions/setup-python@v4
      with:
        python-version: '3.10'

    - name: Install dependencies
      run: |
        python -m pip install --upgrade pip
        pip install pyinstaller xlrd openpyxl

    - name: Create test directory (for building)
      run: |
        # 创建 Vegetable 文件夹避免程序错误
        if (!(Test-Path Vegetable)) {
          New-Item -ItemType Directory -Path Vegetable -Force
        }

    - name: Build EXE file
      run: |
        pyinstaller --onefile ^
          --name "蔬心兰汇总工具" ^
          --hidden-import=xlrd ^
          --hidden-import=openpyxl ^
          --add-data "README.md;." ^  # 如果需要包含其他文件
          main.py

    - name: Test the EXE
      run: |
        cd dist
        # 测试 EXE 是否能运行（不要求功能完整）
        .\蔬心兰汇总工具.exe --version || echo "EXE 构建完成"
        timeout /t 3 /nobreak || echo "程序运行测试"

    - uses: actions/upload-artifact@v4
      with:
        name: 蔬心兰汇总工具
        path: |
          dist/蔬心兰汇总工具.exe
          README.md